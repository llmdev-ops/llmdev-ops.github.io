<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Zen Value ‚Äî Administration</title>
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;500;600;700;800&display=swap" rel="stylesheet" />
  <style>
    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
    :root {
      --green: #aac335; --dark: #414142; --gray: #6b6b6d;
      --light: #f8f8f8; --border: #e2e2e2; --radius: 6px;
      --ff: 'Plus Jakarta Sans', system-ui, sans-serif;
    }
    body { font-family: var(--ff); background: var(--light); color: var(--dark); font-size: 15px; line-height: 1.6; }

    /* LOGIN */
    #login-screen { min-height:100vh; display:flex; align-items:center; justify-content:center; padding:2rem; }
    .login-box { background:white; border-radius:12px; padding:2.8rem 2.4rem; box-shadow:0 4px 32px rgba(0,0,0,.08); width:100%; max-width:440px; }
    .login-logo { height:36px; margin-bottom:2rem; }
    .login-box h1 { font-size:1.3rem; font-weight:800; margin-bottom:.4rem; }
    .login-box > p { font-size:.87rem; color:var(--gray); margin-bottom:1.8rem; }
    .login-box label { display:block; font-size:.72rem; font-weight:700; letter-spacing:.08em; text-transform:uppercase; color:var(--gray); margin-bottom:.35rem; }
    .login-box input { width:100%; padding:.7rem .9rem; border:2px solid var(--border); border-radius:var(--radius); font-family:var(--ff); font-size:.9rem; outline:none; transition:border-color .2s; margin-bottom:1rem; }
    .login-box input:focus { border-color:var(--green); }
    .login-hint { font-size:.78rem; color:var(--gray); margin-bottom:1.4rem; line-height:1.5; }
    .login-hint a { color:var(--green); }
    .login-error { background:#fef2f2; border:1.5px solid #ef4444; color:#b91c1c; padding:.7rem 1rem; border-radius:var(--radius); font-size:.84rem; margin-top:.8rem; display:none; }

    /* BUTTONS */
    .btn { display:inline-block; font-family:var(--ff); font-size:.78rem; font-weight:700; letter-spacing:.07em; text-transform:uppercase; padding:.75rem 1.6rem; border-radius:var(--radius); border:none; cursor:pointer; transition:all .2s; text-decoration:none; }
    .btn-primary { background:var(--green); color:white; width:100%; text-align:center; }
    .btn-primary:hover { background:#8fa828; }
    .btn-sm { padding:.45rem .9rem; font-size:.7rem; }
    .btn-outline { background:transparent; color:var(--dark); border:2px solid var(--border); width:auto; }
    .btn-outline:hover { border-color:var(--green); color:var(--green); }

    /* ADMIN LAYOUT */
    #admin-screen { display:none; min-height:100vh; }
    .admin-header { background:white; border-bottom:2px solid var(--green); padding:0 2rem; height:60px; display:flex; align-items:center; justify-content:space-between; position:sticky; top:0; z-index:100; box-shadow:0 1px 8px rgba(0,0,0,.04); }
    .admin-logo { height:28px; }
    .admin-badge { font-size:.65rem; font-weight:700; letter-spacing:.1em; text-transform:uppercase; background:var(--green); color:white; padding:.25rem .65rem; border-radius:40px; margin-left:.8rem; }
    .admin-user { font-size:.78rem; color:var(--gray); }
    .admin-layout { display:grid; grid-template-columns:230px 1fr; min-height:calc(100vh - 60px); }

    /* SIDEBAR */
    .sidebar { background:white; border-right:1px solid var(--border); padding:1.5rem 0; position:sticky; top:60px; height:calc(100vh - 60px); overflow-y:auto; }
    .sidebar-section { padding:.4rem 1.2rem; font-size:.63rem; font-weight:700; letter-spacing:.12em; text-transform:uppercase; color:var(--gray); opacity:.5; margin-top:1.2rem; }
    .sidebar-item { display:flex; align-items:center; gap:.6rem; padding:.62rem 1.4rem; font-size:.84rem; font-weight:500; color:var(--dark); cursor:pointer; transition:all .15s; border-left:3px solid transparent; }
    .sidebar-item:hover { background:#f3f7e0; color:var(--green); }
    .sidebar-item.active { background:#f3f7e0; color:var(--green); border-left-color:var(--green); font-weight:700; }

    /* MAIN */
    .admin-content { overflow-y:auto; display:flex; flex-direction:column; min-height:calc(100vh - 60px); }
    .admin-main { padding:2rem 2.5rem; max-width:860px; flex:1; }
    .section-title { font-size:1.3rem; font-weight:800; margin-bottom:.3rem; }
    .section-desc { font-size:.85rem; color:var(--gray); margin-bottom:2rem; }

    /* FORM */
    .form-card { background:white; border-radius:10px; padding:1.8rem 2rem; margin-bottom:1.2rem; border:1px solid var(--border); }
    .form-card-title { font-size:.78rem; font-weight:700; letter-spacing:.08em; text-transform:uppercase; color:var(--green); margin-bottom:1.2rem; padding-bottom:.6rem; border-bottom:1px solid var(--border); }
    .field { margin-bottom:1.1rem; }
    .field label { display:block; font-size:.71rem; font-weight:700; letter-spacing:.07em; text-transform:uppercase; color:var(--gray); margin-bottom:.32rem; }
    .field input[type=text],.field input[type=email],.field input[type=url],.field input[type=number],.field textarea,.field select { width:100%; padding:.62rem .8rem; border:1.5px solid var(--border); border-radius:var(--radius); font-family:var(--ff); font-size:.9rem; color:var(--dark); outline:none; transition:border-color .2s; background:white; }
    .field input:focus,.field textarea:focus,.field select:focus { border-color:var(--green); }
    .field textarea { resize:vertical; min-height:90px; }
    .field input[type=color] { width:54px; height:36px; padding:.1rem; border:1.5px solid var(--border); border-radius:var(--radius); cursor:pointer; }
    .field input[type=range] { width:100%; accent-color:var(--green); cursor:pointer; }
    .color-row { display:flex; align-items:center; gap:.7rem; }
    .field-row { display:grid; grid-template-columns:1fr 1fr; gap:1rem; }
    .field-hint { font-size:.74rem; color:var(--gray); margin-top:.22rem; line-height:1.4; }
    .toggle-row { display:flex; align-items:center; gap:.8rem; }
    .toggle { position:relative; width:44px; height:24px; flex-shrink:0; }
    .toggle input { opacity:0; width:0; height:0; }
    .toggle-slider { position:absolute; inset:0; background:#ccc; border-radius:40px; cursor:pointer; transition:.3s; }
    .toggle-slider::before { content:''; position:absolute; width:18px; height:18px; left:3px; bottom:3px; background:white; border-radius:50%; transition:.3s; }
    .toggle input:checked + .toggle-slider { background:var(--green); }
    .toggle input:checked + .toggle-slider::before { transform:translateX(20px); }

    /* PRESETS */
    .preset-grid { display:grid; grid-template-columns:repeat(2,1fr); gap:.7rem; margin-bottom:1rem; }
    .preset-card { border:2px solid var(--border); border-radius:8px; padding:.9rem 1rem; cursor:pointer; transition:all .2s; display:flex; align-items:center; gap:.8rem; }
    .preset-card:hover { border-color:var(--green); background:#f3f7e0; }
    .preset-card.selected { border-color:var(--green); background:#f3f7e0; }
    .preset-dot { width:26px; height:26px; border-radius:50%; flex-shrink:0; }
    .preset-name { font-size:.84rem; font-weight:700; }
    .preset-sub  { font-size:.71rem; color:var(--gray); }

    /* PALETTE */
    .palette-grid { display:flex; gap:.5rem; flex-wrap:wrap; margin-top:.5rem; }
    .palette-chip { width:36px; height:36px; border-radius:6px; border:3px solid transparent; cursor:pointer; transition:transform .15s,border-color .15s; }
    .palette-chip:hover { transform:scale(1.1); }
    .palette-chip.selected { border-color:var(--dark); }

    /* LIST EDITOR */
    .list-items { display:flex; flex-direction:column; gap:.7rem; margin-bottom:.8rem; }
    .list-item { border:1.5px solid var(--border); border-radius:var(--radius); overflow:hidden; }
    .list-item-header { display:flex; align-items:center; justify-content:space-between; padding:.7rem 1rem; background:var(--light); cursor:pointer; font-size:.87rem; font-weight:600; user-select:none; }
    .list-item-header:hover { background:#eef3d6; }
    .list-item-body { padding:1.2rem; display:none; border-top:1px solid var(--border); background:white; }
    .list-item-body.open { display:block; }
    .btn-icon { background:none; border:none; cursor:pointer; font-size:.95rem; padding:.2rem .4rem; border-radius:4px; transition:background .15s; }
    .btn-icon:hover { background:rgba(0,0,0,.07); }
    .item-actions { display:flex; gap:.3rem; }
    .add-btn { display:flex; align-items:center; justify-content:center; gap:.5rem; font-size:.8rem; font-weight:700; color:var(--green); background:#f3f7e0; border:2px dashed var(--green); border-radius:var(--radius); padding:.6rem 1.2rem; cursor:pointer; width:100%; transition:background .2s; }
    .add-btn:hover { background:#eaf0c7; }

    /* SAVE BAR */
    .save-bar { background:white; border-top:1px solid var(--border); padding:1rem 2.5rem; display:flex; align-items:center; justify-content:space-between; gap:1rem; }
    .save-status { font-size:.84rem; color:var(--gray); }
    .save-status.ok  { color:#16a34a; font-weight:600; }
    .save-status.err { color:#dc2626; font-weight:600; }

    /* LOADER */
    .overlay { display:none; position:fixed; inset:0; background:rgba(255,255,255,.75); z-index:999; align-items:center; justify-content:center; font-size:1rem; font-weight:700; color:var(--green); gap:.8rem; }
    .overlay.on { display:flex; }
    .spin { width:20px; height:20px; border:3px solid rgba(0,0,0,.1); border-top-color:var(--green); border-radius:50%; animation:spin .7s linear infinite; }
    @keyframes spin { to { transform:rotate(360deg); } }
  </style>
</head>
<body>

<div class="overlay" id="overlay"><div class="spin"></div> Enregistrement‚Ä¶</div>

<!-- ‚ïê‚ïê LOGIN ‚ïê‚ïê -->
<div id="login-screen">
  <div class="login-box">
    <img src="/assets/images/logo/logo_zen-value_H.avif" alt="Zen Value" class="login-logo" />
    <h1>Administration</h1>
    <p>Connectez-vous avec votre token GitHub pour modifier le site.</p>

    <label>Nom d'utilisateur GitHub</label>
    <input id="gh-user" type="text" placeholder="votre-username" />

    <label>Nom du d√©p√¥t</label>
    <input id="gh-repo" type="text" placeholder="zenvalue-site" />

    <label>Personal Access Token</label>
    <input id="gh-token" type="password" placeholder="ghp_xxxxxxxxxxxxxxxxxxxx" />

    <p class="login-hint">
      Cr√©er un token : <a href="https://github.com/settings/tokens/new?scopes=repo&description=ZenValue+Admin" target="_blank">github.com ‚Üí Settings ‚Üí Developer settings ‚Üí Personal access tokens ‚Üí Tokens (classic)</a><br/>
      Cocher la permission <strong>repo</strong> puis copier le token.
    </p>

    <button class="btn btn-primary" onclick="doLogin()">Connexion</button>
    <div class="login-error" id="login-err"></div>
  </div>
</div>

<!-- ‚ïê‚ïê ADMIN ‚ïê‚ïê -->
<div id="admin-screen">
  <header class="admin-header">
    <div style="display:flex;align-items:center;">
      <img src="/assets/images/logo/logo_zen-value_H.avif" alt="Zen Value" class="admin-logo" />
      <span class="admin-badge">Admin</span>
    </div>
    <div style="display:flex;align-items:center;gap:1rem;">
      <span class="admin-user" id="admin-user-lbl"></span>
      <button class="btn btn-sm btn-outline" onclick="doLogout()">D√©connexion</button>
    </div>
  </header>

  <div class="admin-layout">
    <aside class="sidebar">
      <div class="sidebar-section">Param√®tres</div>
      <div class="sidebar-item active" data-sec="theme"       onclick="nav(this,'theme')">üé® Th√®me graphique</div>
      <div class="sidebar-item"        data-sec="global"      onclick="nav(this,'global')">‚öôÔ∏è Contact & infos</div>
      <div class="sidebar-item"        data-sec="resultats"   onclick="nav(this,'resultats')">üìä Chiffres cl√©s</div>
      <div class="sidebar-section">Pages</div>
      <div class="sidebar-item"        data-sec="accueil"     onclick="nav(this,'accueil')">üè† Accueil</div>
      <div class="sidebar-item"        data-sec="qsn"         onclick="nav(this,'qsn')">üë• Qui sommes-nous</div>
      <div class="sidebar-item"        data-sec="offres"      onclick="nav(this,'offres')">üíº Offres</div>
      <div class="sidebar-item"        data-sec="cas"         onclick="nav(this,'cas')">üèÜ Cas clients</div>
      <div class="sidebar-item"        data-sec="principes"   onclick="nav(this,'principes')">üß≠ Principes</div>
      <div class="sidebar-item"        data-sec="formation"   onclick="nav(this,'formation')">üéì Formation</div>
      <div class="sidebar-item"        data-sec="recrutement" onclick="nav(this,'recrutement')">üôã Recrutement</div>
      <div class="sidebar-item"        data-sec="rse"         onclick="nav(this,'rse')">üå± RSE</div>
    </aside>

    <div class="admin-content">
      <div class="admin-main" id="admin-main">
        <div style="color:#aaa;padding:2rem;">Chargement‚Ä¶</div>
      </div>
      <div class="save-bar">
        <span class="save-status" id="save-status"></span>
        <button class="btn btn-primary" style="width:auto;padding:.7rem 2rem;" onclick="save()">üíæ Enregistrer</button>
      </div>
    </div>
  </div>
</div>

<script>
/* ‚îÄ‚îÄ CONFIG ‚îÄ‚îÄ */
const FILES = {
  theme:       'content/settings/theme.json',
  global:      'content/settings/global.json',
  resultats:   'content/settings/resultats.json',
  accueil:     'content/pages/accueil.json',
  qsn:         'content/pages/qui-sommes-nous.json',
  offres:      'content/pages/offres.json',
  cas:         'content/pages/cas-clients.json',
  principes:   'content/pages/principes.json',
  formation:   'content/pages/formation.json',
  recrutement: 'content/pages/recrutement.json',
  rse:         'content/pages/rse.json',
};

let GH = { user:'', repo:'', token:'' };
let state = { section:'theme', data:{}, sha:'' };

/* ‚îÄ‚îÄ GITHUB API ‚îÄ‚îÄ */
function ghUrl(path) {
  return `https://api.github.com/repos/${GH.user}/${GH.repo}/contents/${path}`;
}
function ghHeaders() {
  return { Authorization:`Bearer ${GH.token}`, Accept:'application/vnd.github+json', 'X-GitHub-Api-Version':'2022-11-28' };
}
async function ghRead(path) {
  const r = await fetch(ghUrl(path), { headers:ghHeaders() });
  if (!r.ok) throw new Error('Lecture ' + path + ' HTTP ' + r.status);
  const d = await r.json();
  // Decodage UTF-8 correct (atob seul corrompt les accents)
  const binary = atob(d.content.replace(/\n/g,''));
  const bytes = new Uint8Array(binary.length);
  for (let i = 0; i < binary.length; i++) bytes[i] = binary.charCodeAt(i);
  const text = new TextDecoder('utf-8').decode(bytes);
  return { data: JSON.parse(text), sha: d.sha };
}
async function ghWrite(path, data, sha) {
  const body = JSON.stringify({
    message: `[Admin] ${path}`,
    content: btoa(unescape(encodeURIComponent(JSON.stringify(data, null, 2)))),
    sha
  });
  const r = await fetch(ghUrl(path), { method:'PUT', headers:{...ghHeaders(),'Content-Type':'application/json'}, body });
  if (!r.ok) { const e = await r.json(); throw new Error(e.message||`HTTP ${r.status}`); }
  return (await r.json()).content.sha;
}

/* ‚îÄ‚îÄ AUTH ‚îÄ‚îÄ */
async function doLogin() {
  const user  = document.getElementById('gh-user').value.trim();
  const repo  = document.getElementById('gh-repo').value.trim();
  const token = document.getElementById('gh-token').value.trim();
  const err   = document.getElementById('login-err');
  err.style.display = 'none';
  if (!user||!repo||!token) { showErr('Tous les champs sont requis.'); return; }
  GH = {user,repo,token};
  const r = await fetch(`https://api.github.com/repos/${user}/${repo}`, {headers:ghHeaders()});
  if (!r.ok) { showErr('Acc√®s refus√©. V√©rifiez le token et le nom du d√©p√¥t.'); return; }
  localStorage.setItem('zv_gh', JSON.stringify(GH));
  startAdmin();
}
function showErr(msg) {
  const el = document.getElementById('login-err');
  el.textContent = msg; el.style.display = 'block';
}
function doLogout() { localStorage.removeItem('zv_gh'); location.reload(); }
function startAdmin() {
  document.getElementById('login-screen').style.display = 'none';
  document.getElementById('admin-screen').style.display = 'block';
  document.getElementById('admin-user-lbl').textContent = `${GH.user}/${GH.repo}`;
  loadSection('theme');
}

/* ‚îÄ‚îÄ NAV ‚îÄ‚îÄ */
function nav(el, sec) {
  document.querySelectorAll('.sidebar-item').forEach(i=>i.classList.remove('active'));
  el.classList.add('active');
  loadSection(sec);
}
async function loadSection(sec) {
  state.section = sec;
  document.getElementById('save-status').textContent = '';
  document.getElementById('admin-main').innerHTML = '<div style="padding:2rem;color:#aaa;"><span style="display:inline-block;width:18px;height:18px;border:2px solid #eee;border-top-color:#aac335;border-radius:50%;animation:spin .7s linear infinite;vertical-align:middle;margin-right:.5rem;"></span>Chargement‚Ä¶</div>';
  try {
    const { data, sha } = await ghRead(FILES[sec]);
    state.data = data; state.sha = sha;
    render(sec, data);
  } catch(e) {
    document.getElementById('admin-main').innerHTML = `<div style="padding:2rem;color:#dc2626;">‚ùå ${e.message}</div>`;
  }
}

/* ‚îÄ‚îÄ SAVE ‚îÄ‚îÄ */
async function save() {
  const status = document.getElementById('save-status');
  document.getElementById('overlay').classList.add('on');
  status.textContent = ''; status.className = 'save-status';
  try {
    const data = collect();
    const newSha = await ghWrite(FILES[state.section], data, state.sha);
    state.sha = newSha; state.data = data;
    status.textContent = '‚úì Enregistr√© ‚Äî mise √† jour du site dans ~30 secondes';
    status.className = 'save-status ok';
  } catch(e) {
    status.textContent = '‚úó Erreur : ' + e.message;
    status.className = 'save-status err';
  } finally {
    document.getElementById('overlay').classList.remove('on');
  }
}

/* ‚îÄ‚îÄ RENDER ‚îÄ‚îÄ */
// Stockage temporaire des valeurs √† injecter apr√®s rendu HTML
let _fieldValues = {};

function f(label, name, val, type='text', hint='') {
  const h = hint ? `<div class="field-hint">${hint}</div>` : '';
  // On stocke la valeur brute ‚Äî elle sera inject√©e via JS apr√®s le rendu
  _fieldValues[name] = val;
  if (type==='textarea') return `<div class="field"><label>${label}</label><textarea name="${name}" data-fill="${name}"></textarea>${h}</div>`;
  return `<div class="field"><label>${label}</label><input type="${type==='text'?'text':type}" name="${name}" data-fill="${name}" />${h}</div>`;
}
function frow(...fields) { return `<div class="field-row">${fields.join('')}</div>`; }
function card(title, body) { return `<div class="form-card"><div class="form-card-title">${title}</div>${body}</div>`; }

// Apr√®s injection du HTML, remplir les champs via JS (g√®re les caract√®res sp√©ciaux nativement)
function fillFields() {
  document.querySelectorAll('[data-fill]').forEach(el => {
    const key = el.getAttribute('data-fill');
    const val = _fieldValues[key];
    if (val === undefined || val === null) return;
    if (el.tagName === 'TEXTAREA') el.value = String(val);
    else el.value = String(val);
  });
}

function render(sec, d) {
  _fieldValues = {};
  const renderers = { theme:rTheme, global:rGlobal, resultats:rResultats, accueil:rAccueil, qsn:rQSN, offres:rOffres, cas:rCas, principes:rPrincipes, formation:rFormation, recrutement:rRecrutement, rse:rRSE };
  document.getElementById('admin-main').innerHTML = renderers[sec] ? renderers[sec](d) : '<p style="padding:2rem">Section inconnue</p>';
  fillFields();
}

function rTheme(d) {
  const presets = [{k:'zenvalue',c:'#aac335',n:'Zen Value',s:'Charte officielle'},{k:'ocean',c:'#2e7cf6',n:'Oc√©an',s:'Bleu professionnel'},{k:'earth',c:'#8b6f4e',n:'Terre',s:'Chaleureux'},{k:'bloom',c:'#9b59b6',n:'Bloom',s:'Cr√©atif'}];
  const pals = [{k:'yellow',c:'#f1e3a6'},{k:'beige',c:'#d6cbbd'},{k:'sage',c:'#c7d4b7'},{k:'lavender',c:'#dbd3e8'},{k:'blue',c:'#cedff4'}];
  const isCustom = d.preset==='custom';
  return `
    <div class="section-title">üé® Th√®me graphique</div>
    <div class="section-desc">Choisissez un preset ou configurez manuellement les couleurs.</div>
    ${card('Preset', `
      <div class="preset-grid">
        ${presets.map(p=>`<div class="preset-card ${d.preset===p.k?'selected':''}" onclick="pickPreset('${p.k}',this)"><div class="preset-dot" style="background:${p.c}"></div><div><div class="preset-name">${p.n}</div><div class="preset-sub">${p.s}</div></div></div>`).join('')}
      </div>
      <div class="preset-card ${isCustom?'selected':''}" style="margin-top:.5rem;max-width:210px;" onclick="pickPreset('custom',this)">
        <div class="preset-dot" style="background:linear-gradient(135deg,#aac335,#9b59b6)"></div>
        <div><div class="preset-name">‚úèÔ∏è Personnalis√©</div><div class="preset-sub">Configurer librement</div></div>
      </div>
      <input type="hidden" name="preset" id="preset-val" value="${d.preset||'zenvalue'}" />
    `)}
    <div id="custom-block" style="${isCustom?'':'opacity:.4;pointer-events:none'}">
      ${card('Couleurs', `
        ${frow(
          `<div class="field"><label>Couleur primaire</label><div class="color-row"><input type="color" id="cp" value="${d.couleur_primaire||'#aac335'}" oninput="syncHex('cp','hp',this.value)" /><input type="text" id="hp" name="couleur_primaire" value="${d.couleur_primaire||'#aac335'}" oninput="syncPicker('cp',this.value)" /></div></div>`,
          `<div class="field"><label>Couleur sombre</label><div class="color-row"><input type="color" id="cd" value="${d.couleur_sombre||'#414142'}" oninput="syncHex('cd','hd',this.value)" /><input type="text" id="hd" name="couleur_sombre" value="${d.couleur_sombre||'#414142'}" oninput="syncPicker('cd',this.value)" /></div></div>`
        )}
        <div class="field" style="margin-top:.3rem;">
          <label>Palette compl√©mentaire</label>
          <div class="palette-grid">
            ${pals.map(p=>`<div class="palette-chip ${(d.palette_complementaire||'yellow')===p.k?'selected':''}" style="background:${p.c}" title="${p.k}" onclick="pickPal('${p.k}',this)"></div>`).join('')}
          </div>
          <input type="hidden" name="palette_complementaire" id="pal-val" value="${d.palette_complementaire||'yellow'}" />
        </div>
      `)}
      ${card('Typographie & Style', `
        <div class="field">
          <label>Police</label>
          <select name="typographie">
            ${[['jakarta','Plus Jakarta Sans (‚âà Gilroy)'],['inter','Inter'],['dm','DM Sans'],['outfit','Outfit']].map(([k,l])=>`<option value="${k}" ${d.typographie===k?'selected':''}>${l}</option>`).join('')}
          </select>
        </div>
        <div class="field">
          <label>Arrondi boutons ‚Äî <span id="rv">${d.rayon_boutons||4}</span>px</label>
          <input type="range" name="rayon_boutons" min="0" max="40" value="${d.rayon_boutons||4}" oninput="document.getElementById('rv').textContent=this.value" />
        </div>
        <div class="field">
          <label>Ombres port√©es</label>
          <div class="toggle-row">
            <label class="toggle"><input type="checkbox" name="ombre_activee" ${d.ombre_activee!==false?'checked':''}/><span class="toggle-slider"></span></label>
            <span style="font-size:.85rem">Activ√©es</span>
          </div>
        </div>
        <div class="field">
          <label>Fond hero (panneau droit)</label>
          <select name="hero_fond_droite">
            <option value="dark"   ${(d.hero_fond_droite||'dark')==='dark'  ?'selected':''}>Anthracite (d√©faut)</option>
            <option value="green"  ${d.hero_fond_droite==='green'  ?'selected':''}>Couleur primaire</option>
            <option value="accent" ${d.hero_fond_droite==='accent' ?'selected':''}>Couleur accent</option>
          </select>
        </div>
      `)}
    </div>`;
}

function rGlobal(d) { return `<div class="section-title">‚öôÔ∏è Contact & informations</div><div class="section-desc">Coordonn√©es affich√©es dans le footer et sur la page Contact.</div>${card('',`${f('Email','email',d.email)}${f('Adresse','adresse',d.adresse)}${f('Nom LinkedIn','linkedin',d.linkedin)}${f('URL LinkedIn','linkedin_url',d.linkedin_url)}${f('Copyright footer','copyright',d.copyright)}`)}`;
}
function rResultats(d) {
  return `<div class="section-title">üìä Chiffres cl√©s</div><div class="section-desc">Les 4 r√©sultats mesur√©s chez vos clients.</div>
    ${[1,2,3,4].map(n=>card(`R√©sultat ${n}`,frow(f('Chiffre',`r${n}_chiffre`,d[`r${n}_chiffre`]),f('Label',`r${n}_label`,d[`r${n}_label`])))).join('')}`;
}
function rAccueil(d) {
  return `<div class="section-title">üè† Accueil</div><div class="section-desc">Hero, stats et messages de la page d'accueil.</div>
    ${card('Hero',`${f('Accroche','eyebrow',d.eyebrow)}${f('Tagline ligne 1','tagline1',d.tagline1)}${f('Tagline ligne 2 (italique)','tagline2',d.tagline2)}${f('Sous-titre','soustitre',d.soustitre,'textarea')}${frow(f('Bouton principal','cta1',d.cta1),f('Bouton secondaire','cta2',d.cta2))}`)}
    ${card('Panneau sombre',`${f('Badge','badge',d.badge)}${f('Citation','quote',d.quote,'textarea')}`)}
    ${card('Statistiques',`${frow(f('Stat 1 chiffre','stat1_num',d.stat1_num),f('Stat 1 label','stat1_label',d.stat1_label))}${frow(f('Stat 2 chiffre','stat2_num',d.stat2_num),f('Stat 2 label','stat2_label',d.stat2_label))}${frow(f('Stat 3 chiffre','stat3_num',d.stat3_num),f('Stat 3 label','stat3_label',d.stat3_label))}`)}`;
}
function rQSN(d) {
  return `<div class="section-title">üë• Qui sommes-nous</div><div class="section-desc">Discours, vision et histoire.</div>
    ${card('Discours',`${f('Paragraphe 1','discours1',d.discours1,'textarea')}${f('Paragraphe 2','discours2',d.discours2,'textarea')}${f('Paragraphe 3','discours3',d.discours3,'textarea')}`)}
    ${card('Vision & Mission',`${f('Vision','vision',d.vision,'textarea')}${f('Mission','mission',d.mission,'textarea')}`)}
    ${card('Histoire',`${f('Paragraphe 1','histoire1',d.histoire1,'textarea')}${f('Paragraphe 2','histoire2',d.histoire2,'textarea')}${f('Paragraphe 3','histoire3',d.histoire3,'textarea')}`)}`;
}
function rFormation(d) {
  return `<div class="section-title">üéì Formation</div>${card('',`${f('Titre','titre',d.titre)}${f('Sous-titre','soustitre',d.soustitre,'textarea')}${f('Texte Qualiopi 1','texte1',d.texte1,'textarea')}${f('Texte Qualiopi 2','texte2',d.texte2,'textarea')}${f('URL catalogue','catalogue_url',d.catalogue_url)}`)}`;
}
function rRSE(d) {
  return `<div class="section-title">üå± RSE</div>
    ${card('',`${f('Titre','titre',d.titre)}${f('Introduction','intro',d.intro,'textarea')}${f('Axe 1 ‚Äî Titre','axe1_titre',d.axe1_titre)}${f('Axe 1 ‚Äî Texte','axe1_texte',d.axe1_texte,'textarea')}${f('Axe 2 ‚Äî Titre','axe2_titre',d.axe2_titre)}${f('Axe 2 ‚Äî Texte','axe2_texte',d.axe2_texte,'textarea')}`)}
    ${listCard('Mesures concr√®tes','list-mesures',d.mesures||[],['icon','titre','texte'],'addMesure')}`;
}
function rOffres(d) {
  return `<div class="section-title">üíº Offres</div>
    ${listCard('Liste des offres','list-offres',d.items||[],['categorie','titre','description','cta_label'],'addOffre')}`;
}
function rCas(d) {
  return `<div class="section-title">üèÜ Cas clients</div>
    <div class="form-card">
      <div class="form-card-title">Liste des cas clients</div>
      <div class="list-items" id="list-cas">
        ${(d.items||[]).map((c,i)=>`
          <div class="list-item">
            <div class="list-item-header" onclick="toggleBody(this)">
              <span>Cas ${i+1} ‚Äî ${esc(c.titre)}</span>
              <div class="item-actions"><button class="btn-icon" onclick="delItem(event,this)">üóë</button></div>
            </div>
            <div class="list-item-body">
              ${f('Titre',`items[${i}].titre`,c.titre)}
              ${f('Citation',`items[${i}].citation`,c.citation,'textarea')}
              ${f('Description',`items[${i}].description`,c.description,'textarea')}
              <div style="font-size:.7rem;font-weight:700;text-transform:uppercase;color:var(--gray);margin:.8rem 0 .4rem;">R√©sultats</div>
              ${(c.resultats||[]).map((r,j)=>frow(f('Chiffre',`items[${i}].resultats[${j}].chiffre`,r.chiffre),f('Label',`items[${i}].resultats[${j}].label`,r.label))).join('')}
            </div>
          </div>`).join('')}
      </div>
      <button class="add-btn" onclick="addCas()">+ Ajouter un cas client</button>
    </div>`;
}
function rPrincipes(d) {
  return `<div class="section-title">üß≠ Principes fondateurs</div>
    ${listCard('Principes','list-principes',d.items||[],['icon','titre','description'],'addPrincipe')}`;
}
function rRecrutement(d) {
  return `<div class="section-title">üôã Recrutement</div>
    ${card('En-t√™te',`${f('Titre','titre',d.titre)}${f('Sous-titre','soustitre',d.soustitre,'textarea')}${f('Introduction','intro',d.intro,'textarea')}${f('Tagline','tagline',d.tagline)}`)}
    ${listCard('Engagements','list-engagements',d.engagements||[],['icon','titre','texte'],'addEngagement')}
    ${listCard('Profils recherch√©s','list-profils',d.profils||[],['icon','titre','description'],'addProfil')}`;
}

/* ‚îÄ‚îÄ LIST CARD HELPER ‚îÄ‚îÄ */
function listCard(title, id, items, fields, addFn) {
  const labels = {icon:'Ic√¥ne (emoji)',titre:'Titre',description:'Description',texte:'Texte',categorie:'Cat√©gorie',cta_label:'Label bouton'};
  return `<div class="form-card">
    <div class="form-card-title">${title}</div>
    <div class="list-items" id="${id}">
      ${items.map((item,i)=>`
        <div class="list-item">
          <div class="list-item-header" onclick="toggleBody(this)">
            <span>${esc(item.icon||'')} ${esc(item.titre||item.categorie||'√âl√©ment '+(i+1))}</span>
            <div class="item-actions">
              <button class="btn-icon" onclick="moveUp(event,this)">‚Üë</button>
              <button class="btn-icon" onclick="moveDn(event,this)">‚Üì</button>
              <button class="btn-icon" onclick="delItem(event,this)">üóë</button>
            </div>
          </div>
          <div class="list-item-body">
            ${fields.map(fk=>fk==='texte'||fk==='description'?f(labels[fk]||fk,`${id.replace('list-','')}[${i}].${fk}`,item[fk],'textarea'):f(labels[fk]||fk,`${id.replace('list-','')}[${i}].${fk}`,item[fk])).join('')}
          </div>
        </div>`).join('')}
    </div>
    <button class="add-btn" onclick="${addFn}('${id}')">+ Ajouter</button>
  </div>`;
}

/* ‚îÄ‚îÄ LIST ACTIONS ‚îÄ‚îÄ */
function toggleBody(hdr) { hdr.nextElementSibling.classList.toggle('open'); }
function delItem(e, btn) { e.stopPropagation(); if(confirm('Supprimer ?')) btn.closest('.list-item').remove(); }
function moveUp(e, btn)  { e.stopPropagation(); const li=btn.closest('.list-item'); const prev=li.previousElementSibling; if(prev) li.parentNode.insertBefore(li,prev); }
function moveDn(e, btn)  { e.stopPropagation(); const li=btn.closest('.list-item'); const next=li.nextElementSibling; if(next) li.parentNode.insertBefore(next,li); }

function addToList(listId, fields) {
  const labels = {icon:'Ic√¥ne (emoji)',titre:'Titre',description:'Description',texte:'Texte',categorie:'Cat√©gorie',cta_label:'Label bouton'};
  const i = document.getElementById(listId).querySelectorAll('.list-item').length;
  const body = fields.map(fk=>{
    const type = (fk==='texte'||fk==='description')?'textarea':'text';
    return `<div class="field"><label>${labels[fk]||fk}</label>${type==='textarea'?`<textarea name="new_${fk}"></textarea>`:`<input type="text" name="new_${fk}" />`}</div>`;
  }).join('');
  const html = `<div class="list-item"><div class="list-item-header" onclick="toggleBody(this)"><span>Nouvel √©l√©ment</span><div class="item-actions"><button class="btn-icon" onclick="delItem(event,this)">üóë</button></div></div><div class="list-item-body open">${body}</div></div>`;
  document.getElementById(listId).insertAdjacentHTML('beforeend', html);
}

function addOffre(id)       { addToList(id||'list-offres',      ['categorie','titre','description','cta_label']); }
function addCas()           { addToList('list-cas',             ['titre','citation','description']); }
function addPrincipe(id)    { addToList(id||'list-principes',   ['icon','titre','description']); }
function addMesure(id)      { addToList(id||'list-mesures',     ['icon','titre','texte']); }
function addEngagement(id)  { addToList(id||'list-engagements', ['icon','titre','texte']); }
function addProfil(id)      { addToList(id||'list-profils',     ['icon','titre','description']); }

/* ‚îÄ‚îÄ THEME HELPERS ‚îÄ‚îÄ */
function pickPreset(key, el) {
  document.querySelectorAll('.preset-card').forEach(c=>c.classList.remove('selected'));
  el.classList.add('selected');
  document.getElementById('preset-val').value = key;
  const block = document.getElementById('custom-block');
  if (block) { block.style.opacity = key==='custom'?'1':'.4'; block.style.pointerEvents = key==='custom'?'auto':'none'; }
}
function pickPal(key, el) {
  document.querySelectorAll('.palette-chip').forEach(c=>c.classList.remove('selected'));
  el.classList.add('selected');
  document.getElementById('pal-val').value = key;
}
function syncHex(pickerId, hexId, val) { document.getElementById(hexId).value = val; }
function syncPicker(pickerId, val) { if(/^#[0-9a-fA-F]{6}$/.test(val)) document.getElementById(pickerId).value = val; }
function esc(s) { return String(s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/"/g,'&quot;'); }

/* ‚îÄ‚îÄ COLLECT ‚îÄ‚îÄ */
function collect() {
  const main = document.getElementById('admin-main');
  const data = {};

  // Champs simples
  main.querySelectorAll('[name]').forEach(el => {
    const n = el.name;
    if (!n || n.startsWith('new_')) return;
    // Ignorer les champs de liste complexes
    if (n.includes('[')) return;
    if (el.type==='checkbox') data[n] = el.checked;
    else if (el.type==='range'||el.type==='number') data[n] = isNaN(Number(el.value)) ? el.value : Number(el.value);
    else data[n] = el.value;
  });

  // Listes selon la section
  const sec = state.section;
  if (sec==='offres')      data.items      = collectList('list-offres',      ['categorie','titre','description','cta_label']);
  if (sec==='cas')         data.items      = collectCas();
  if (sec==='principes')   data.items      = collectList('list-principes',   ['icon','titre','description']);
  if (sec==='rse')         data.mesures    = collectList('list-mesures',      ['icon','titre','texte']);
  if (sec==='recrutement') {
    data.engagements = collectList('list-engagements', ['icon','titre','texte']);
    data.profils     = collectList('list-profils',     ['icon','titre','description']);
    data.processus   = state.data.processus || [];
  }

  return data;
}

function collectList(listId, fields) {
  const container = document.getElementById(listId);
  if (!container) return [];
  return Array.from(container.querySelectorAll('.list-item')).map(item => {
    const obj = {};
    item.querySelectorAll('[name]').forEach(el => {
      // Extraire le nom du champ (derni√®re partie apr√®s le dernier point)
      const key = el.name.split('.').pop().replace(/new_/,'');
      if (key && !key.includes('[')) obj[key] = el.value;
    });
    return obj;
  });
}

function collectCas() {
  const container = document.getElementById('list-cas');
  if (!container) return [];
  return Array.from(container.querySelectorAll('.list-item')).map(item => {
    const obj = { titre:'', citation:'', description:'', resultats:[] };
    item.querySelectorAll('[name]').forEach(el => {
      const n = el.name;
      if (n.includes('resultats')) {
        const m = n.match(/resultats\[(\d+)\]\.(\w+)/);
        if (m) {
          const ri = parseInt(m[1]);
          while (obj.resultats.length <= ri) obj.resultats.push({chiffre:'',label:''});
          obj.resultats[ri][m[2]] = el.value;
        }
      } else {
        const key = n.split('.').pop().replace(/new_/,'');
        if (key && !key.includes('[')) obj[key] = el.value;
      }
    });
    return obj;
  });
}

/* ‚îÄ‚îÄ INIT ‚îÄ‚îÄ */
window.addEventListener('DOMContentLoaded', () => {
  try {
    const saved = localStorage.getItem('zv_gh');
    if (saved) { GH = JSON.parse(saved); startAdmin(); }
  } catch(e) { localStorage.removeItem('zv_gh'); }
});
</script>
</body>
</html>
